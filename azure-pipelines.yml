variables:
  projectDirectory: jama

trigger:
- master

pool:
  vmImage: 'macOS-10.13'

jobs:
  - job: Build & Test JaMa
    steps:
    - task: InstallAppleCertificate@2
      inputs:
        certSecureFile: 'Hsco_cert.p12'
        certPwd: '$(privateKeyPassword)'
        keychain: 'temp'
      displayName: Installing iOS Certificate
    - task: InstallAppleProvisioningProfile@1
      inputs:
        provisioningProfileLocation: 'secureFiles'
        provProfileSecureFile: 'HSCO.mobileprovision'
      displayName: Installing iOS Mobile Provisioning Profile
    - task: FlutterInstall@0
    - script: |
        echo $(FlutterToolPath)
        export PATH=$PATH:$(FlutterToolPath):$(FlutterToolPath)/cache/dart-sdk/bin:$(FlutterToolPath)/../.pub-cache/bin/
        echo $PATH
        flutter pub global activate pubspec_version
        pubver bump build
      displayName: Increment build number.
    - task: FlutterBuild@0
      inputs:
        target: 'all'
        projectDirectory: '.'
      displayName: Build Android & iOS App.
    - task: FlutterTest@0
      inputs:
        projectDirectory: '.'
      displayName: Run Unit Tests.
    - task: AppStoreRelease@1
      inputs:
        serviceEndpoint: 'Apple Store'
        appIdentifier: 'com.hsco.jama'
        appType: 'iOS'
        ipaPath: '**/*.ipa'
        releaseTrack: 'TestFlight'
      displayName: Releasing to Alpha Testers
    - script: |
        git config --global user.email "tk@hinterlandsupply.co"
        git config --global user.name "Azure DevOps CI"
        git add pubspec.yaml
        git commit -m "Updated Automated Build Number [skip ci]"
        git pull origin master --rebase
        git push https://$USERNAME:$PASSWORD@github.com/hinterlandsupplyco/JaMa.git HEAD:master
      displayName: Push updated pubspec
  
